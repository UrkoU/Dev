<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
  </head>
  <body id="body">
    <div id="divGame"></div>
    <div id="divTime"></div>
    <div id="divResult"></div>
    <script src="http://185.60.40.210/2daw3/FuncionesJuegos.js"></script>
    <script>
      var n = 3;
      var timeLimit = [1, 5, 8, 11, 14, 20];
      var nums = CrearTabla(n);
      var numsOrdenados = CrearTablaOrdenada();
      var f0 = n - 1;
      var c0 = n - 1;
      var bBotonesActivados = true;
      var clicks = 0;
      MostrarNums();
      // Si la tabla viene resuelta por defecto volver a crearla
      while (Comprobar()) {
        nums = CrearTabla(n);
        MostrarNums();
      }
      var iIntervalo = setInterval(Reloj, 1000);

      function MostrarNums() {
        let i = 0;
        let j = 0;
        document.getElementById("divGame").innerHTML = `<table id="tJuego" style="border-collapse: collapse;"></table>`;

        for (let i = 0; i < nums.length; i++) {
          document.getElementById("tJuego").innerHTML += `<tr id=tr${i}></tr>`;
          for (let j = 0; j < nums[i].length; j++) {
            document.getElementById(
              `tr${i}`
            ).innerHTML += `<td id=td${i}-${j}  style="border: 1px solid"><img id="Bola${i}${j}" src="numbers/n${nums[i][j]}.gif"  onclick="Cambiar(${i}, ${j})"></td>`;
          }
        }
      }

      function CrearTablaOrdenada() {
        let a = new Array(n);
        let x = 1;
        for (let i = 0; i < n; i++) {
          a[i] = new Array(n);
          for (let j = 0; j < n; j++) {
            a[i][j] = x;
            x++;
          }
        }
        a[n - 1][n - 1] = 0;
        return a;
      }

      function Cambiar(f, c) {
        if (bBotonesActivados) {
          clicks++;
          MostrarClicks(clicks);
          if ((f == f0 && (c == c0 - 1 || c == c0 + 1)) || (c == c0 && (f == f0 - 1 || f == f0 + 1))) {
            Intercambiar(nums, f0, c0, f, c);
            c0 = c;
            f0 = f;
            MostrarNums();
            if (Comprobar()) TerminarJuego(true);
          }
        }
      }

      function Comprobar() {
        let bIgual = true;
        for (let i = 0; i < n; i++) {
          for (let j = 0; j < n; j++) {
            if (nums[i][j] != numsOrdenados[i][j]) {
              bIgual = false;
              break;
            }
          }
          if (bIgual == false) break;
        }
        return bIgual;
      }

      function TerminarJuego(ganado) {
        IntercambiarBotonesActivados();
        if (ganado) MostrarMensaje("Juego terminado con éxito");
        else MostrarMensaje("No has conseguido completar el juego con éxito, tiempo agotado");
        bBotonesActivados = false;
        clearInterval(iIntervalo);
      }

      function IntercambiarBotonesActivados() {
        bBotonesActivados = !bBotonesActivados;
      }

      function MostrarMensaje(mensaje) {
        document.getElementById("divResult").innerHTML += `<h1>${mensaje}</h1>`;
      }

      function MostrarClicks(clicks) {
        // alert("Clicks: " + clicks);
        document.getElementById("divResult").innerHTML = `<h1>${clicks}</h1>`;
      }

      var hora = new Date();
      var nueva = new Date(hora.getTime() + timeLimit[n - 2] * 60000);

      function Reloj() {
        var tiempoRestante = new Date(nueva - new Date());
        if (tiempoRestante.getMinutes() == 0 && tiempoRestante.getSeconds() == 0) {
          bBotonesActivados = false;
          TerminarJuego(false);
        }
        let time =
          tiempoRestante.getMinutes().toString() +
          ":" +
          (tiempoRestante.getSeconds() > 9
            ? tiempoRestante.getSeconds().toString()
            : `0${tiempoRestante.getSeconds().toString()}`);
        document.getElementById("divTime").innerHTML = time;
      }
    </script>
  </body>
</html>
